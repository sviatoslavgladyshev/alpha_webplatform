<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="icon" href="../images/lvlup_logo.png">
    <link rel="stylesheet" href="../styles/home_styles.css">
</head>
<body>
    <div class="preloader">
        <div class="loader">
            <div class="cube">
                <div class="cube-face"><img src="../images/lvlup_logo.png" alt="Logo"></div>
                <div class="cube-face"><img src="../images/lvlup_logo.png" alt="Logo"></div>
                <div class="cube-face"><img src="../images/lvlup_logo.png" alt="Logo"></div>
                <div class="cube-face"><img src="../images/lvlup_logo.png" alt="Logo"></div>
                <div class="cube-face"><img src="../images/lvlup_logo.png" alt="Logo"></div>
                <div class="cube-face"><img src="../images/lvlup_logo.png" alt="Logo"></div>
            </div>
        </div>
        <div class="loading-text">Loading</div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo">
                <span class="logo-icon">U</span>
                <span id="username"></span>
            </div>
            <nav class="nav-tabs"></nav>
            <!-- <div class="header-buttons">
                <button id="dateRangeButton" class="date-range-button"></button>
            </div> -->
        </header>

        <div class="dashboard">
            <div class="tab-content active" id="admin">
                <div class="card" style="width: 100%;">
                    <h2>Employer Code Generator</h2>
                    <div class="code-management">
                        <div class="code-actions">
                            <button id="generateCodeBtn" class="btn-primary">Generate New Company Code</button>
                            <input type="text" id="codeInput" placeholder="Enter code">
                            <input type="text" id="employeeIdInput" placeholder="Enter employee ID">
                            <button id="useCodeBtn" class="btn-primary">Use Code</button>
                        </div>
                        <div id="codeStatus"></div>
                        <div class="code-list">
                            <h4>Active Company Codes</h4>
                            <div id="activeCodesList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.799.0/aws-sdk.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.0.1/dist/chart.umd.min.js"></script>
    <script>
        let username = '';
        const API_ENDPOINT = 'https://028fsljya7.execute-api.us-east-1.amazonaws.com/dev';

        async function callAPI(path, method, payload = null) {
            const url = `${API_ENDPOINT}${path}`;
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            if (payload) {
                options.body = JSON.stringify(payload);
            }

            console.log('Calling API:', { url, method, payload });

            try {
                const response = await fetch(url, options);
                const data = await response.json();
                console.log('API Response:', data);

                if (!response.ok) {
                    throw new Error(data.message || 'API call failed');
                }

                return data;
            } catch (error) {
                console.error(`Error calling API ${path}:`, error);
                throw error;
            }
        }

        async function generateCompanyCode() {
            const generateCodeBtn = document.getElementById('generateCodeBtn');
            addLoadingState(generateCodeBtn);
            try {
                const response = await callAPI('/employer-codes?operation=generate', 'POST', { username });
                if (response.code) {
                    document.getElementById('codeStatus').textContent = `New code generated: ${response.code}`;
                    fetchActiveCodes();
                } else {
                    document.getElementById('codeStatus').textContent = 'Failed to generate company code';
                }
            } catch (error) {
                document.getElementById('codeStatus').textContent = 'Error generating company code: ' + error.message;
            } finally {
                removeLoadingState(generateCodeBtn);
            }
        }

        async function fetchActiveCodes() {
        try {
            const response = await callAPI(`/employer-codes?operation=fetch&username=${username}`, 'GET');
            console.log('API Response:', response);
            const activeCodesList = document.getElementById('activeCodesList');
            activeCodesList.innerHTML = '';

            if (response.codes && response.codes.length > 0) {
                response.codes.forEach(code => {
                    const codeItem = document.createElement('div');
                    codeItem.className = 'code-item';
                    codeItem.innerHTML = `
                        <span>${code.code} (Expires: ${new Date(code.expiresAtReadable).toLocaleString()})</span>
                        <button onclick="deleteCode('${code.code}')">Delete</button>
                    `;
                    activeCodesList.appendChild(codeItem);
                });
            } else {
                activeCodesList.innerHTML = '<p>No active codes available.</p>';
            }
        } catch (error) {
            console.error('Error fetching active codes:', error);
        }
    }

        document.addEventListener('DOMContentLoaded', function () {
            const token = localStorage.getItem('idToken');
            if (token) {
                const decodedToken = parseJwt(token);
                username = decodedToken['cognito:username'];
                document.getElementById('username').textContent = username;
            } else {
                window.location.href = '../login/';
            }

            const generateCodeBtn = document.getElementById('generateCodeBtn');
            if (generateCodeBtn) {
                generateCodeBtn.addEventListener('click', generateCompanyCode);
            }

            fetchActiveCodes();
        });

        function addLoadingState(button) {
            button.disabled = true;
            const spinner = document.createElement('span');
            spinner.className = 'spinner';
            button.appendChild(spinner);
        }

        function removeLoadingState(button) {
            button.disabled = false;
            const spinner = button.querySelector('.spinner');
            if (spinner) {
                button.removeChild(spinner);
            }
        }

        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(
                atob(base64)
                    .split('')
                    .map(function (c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    })
                    .join('')
            );
            return JSON.parse(jsonPayload);
        }
    </script>
</body>
</html>